---
title: "Self-Targeted Isoform Changes"
author: "Mervin M Fansler"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document: 
    code_folding: show
    toc: true
    toc_float: true
---

# Purpose

Does repression of transcriptional activity via CRISPR interference have a non-uniform
effect on isoform abundances of the targeted gene? In this document, we consider 
all targeted perturbations for genes with multiple isoforms. If a common bias against
isoforms in particular positions (e.g., IPA, short, long) is present, then this should
be detectable with a statistic aggregated across all the targeted multi-UTR genes.

We can adopt the null hypothesis that isoform usage does not change in any specific 
way, namely, that any such statistics should not deviate significantly from similar 
ones comupted in any non-targeting "perturbations".

# Initialization

## Libraries
```{r libs, message=FALSE, warning=FALSE}
library(magrittr)
library(tidyverse)
library(cowplot)
library(ggbeeswarm)
library(plotly)
library(Matrix)
library(sparseMatrixStats)
library(SingleCellExperiment)
```

## Parameters
```{r set_params}
set.seed(20220901)
MIN_UMIS=1000
N_EXAMPLE_PLOTS=25
FILE_SE_TX="data/se/kd6_essential_bulk_expressed.Rds"
```

# Data
## Loading
```{r load_data, message=FALSE}
se_tx_target <- readRDS(FILE_SE_TX)
```

## Preprocessing
### Identify Targeted Multi-UTR Genes
```{r identify_multi_targets}
gene_targets <- se_tx_target$target_gene_id %>% 
    unique %>%
    `[`(str_detect(., "^ENSG")) 

df_sampled <- rowData(se_tx_target) %>%
    as_tibble %>%
    mutate(ensembl_id=str_remove(gene_id, "\\.[0-9]+$")) %>%
    filter(ensembl_id %in% gene_targets)

cts_tx_target <- assay(se_tx_target, "counts")
    
df_multi <- df_sampled %>%
    filter(utr_type_raw == 'multi') %>%
    ## only consider expressed isoforms
    filter(rowSums(cts_tx_target[transcript_id,]) >= MIN_UMIS) %>%
    group_by(ensembl_id) %>%
    ## must have multiple expressed isoforms
    filter(dplyr::n() > 1) %>%
    ## recompute utr rank
    mutate(utr_rank_expr=rank(utr_rank),
           utr_wt=(utr_rank_expr - 1)/(max(utr_rank_expr) - 1)) %>%
    ungroup() %>%
    select(transcript_id, transcript_name, gene_id, gene_name, ensembl_id, 
           utr_rank, utr_rank_expr, utr_wt)

idx_tx <- df_multi$transcript_id

df_multi %>% distinct(ensembl_id) %>% nrow %>% 
    sprintf(fmt="Found %d targeted multi-UTR genes.")

df_multi %>% nrow %>% 
    sprintf(fmt="These consist of %d 3' UTR isoforms.")
```

### Missing Readouts
Are there any genes that are targeted, but are not identified via ENSEMBL IDs as
being measured in the feature set? 
```{r print_missing_genes}
colData(se_tx_target) %>% as_tibble %>%
    filter(target_gene_id %in% gene_targets[!(gene_targets %in% df_sampled$ensembl_id)]) %>%
    distinct(target_gene, target_gene_id, sgID_AB) %>%
    knitr::kable()
```

Yes, a handful.

### Compute average WUI for non-targeting samples
The weighted usage index (WUI) is computed by assigning the expressed isoforms a
rank based on cleavage position, $1..n$, where 1 is the most proximal and $n$ the 
most distal. Each position, is then evenly distributed on the closed unit interval.
For example, a gene with three isoforms would have isoform weights of 0.0, 0.5, and 1.0.
These weights are then multiplied by the respective usage ratios for each isoform 
in the gene. The set of weighted usage index values are then averaged across the 
set of considered genes.

In the following, we compute this statistic for each of the non-targeting samples.
```{r compute_awui_nt}
wt_tx <- df_multi %>% dplyr::select(transcript_id, utr_wt) %>% deframe

M_gene_tx <- df_multi$ensembl_id %>% fac2sparse

cts_gene_target <- M_gene_tx %*% cts_tx_target[idx_tx,]
ui_tx_target <- cts_tx_target[idx_tx,] / (t(M_gene_tx) %*% cts_gene_target)
#ui_tx_target[is.na(ui_tx_target)] <- 0

wui_gene_target <- M_gene_tx %*% Diagonal(length(wt_tx), wt_tx) %*% ui_tx_target

idx_nt <- str_detect(colnames(ui_tx_target), fixed("non-targeting"))

awui_all <- colMeans(wui_gene_target, na.rm=TRUE)

df_awui <- enframe(awui_all, name="sgID_AB", value="awui") %>%
    mutate(is_nt=str_detect(sgID_AB, fixed("non-targeting")))

df_awui %>% 
    ggplot(aes(x=is_nt, y=awui)) + 
    geom_boxplot() +
    scale_y_continuous() +
    theme_bw() +
    labs(x="Non-Targeting", y="Average Weighted Usage Index")
```

### Compute composite average WUI across self-targets
For each perturbation targeting a multi-UTR gene, we compute the WUI for the targeted
gene. When multiple perturbnations target the same gene, we take the mean for that gene.
These per-gene WUI values are then averaged to yield an average WUI composited from
usage indices across the various perturbations.

```{r compute_awui_self}
ens_gene <- rownames(wui_gene_target) %>% set_names(.)

ens_target <- colData(se_tx_target) %>% as_tibble %>%
    select(sgID_AB, target_gene_id) %>% distinct %>%
    deframe %>% `[`(colnames(wui_gene_target))

I_gene_target <- outer(ens_gene, ens_target, "==") %>% as("lgTMatrix")

awui_self <- wui_gene_target[cbind(I_gene_target@i+1, I_gene_target@j+1)] %>%
    `names<-`(ens_gene[I_gene_target@i+1]) %>% 
    enframe(name="gene", value="wui") %>%
    filter(!is.na(wui)) %>%
    group_by(gene) %>%
    summarize(wui=mean(wui)) %$%
    mean(wui)

#awui_self <- as.numeric(wt_tx %*% (rowSums(ui_tx_target * I_tx_target) / rowSums(I_tx_target)) / n_genes)

df_awui %<>% add_row(sgID_AB="self-targeting composite", awui=awui_self, is_nt=FALSE)
```


# Analysis

## AWUI Distribution
### Non-Targets vs Composite
```{r plt_awui_violin, fig.width=2, fig.height=4}
df_awui %>%
    filter(str_detect(sgID_AB, "targeting")) %>%
        ggplot(aes(x="Perturbations", y=awui)) +
    geom_violin(fill='lightgrey', size=0.2, draw_quantiles=c(0.25, 0.50, 0.75)) +
    geom_quasirandom(aes(color=is_nt), pch=16, size=2) +
    scale_color_manual(values=c("blue", "black"), guide='none') +
    theme_bw() +
    labs(x=NULL, y="Weighted Usage Index")
```

### t-Test 
Assuming normality and homoskedasticity, we can use a t-test to test whether
the average weighted usage index for the composite is consistent with the distribution
of values from the non-targeting cases.

```{r t_test}
t.test(filter(df_awui, is_nt)$awui, 
       filter(df_awui, sgID_AB == "self-targeting composite")$awui,
       var.equal=TRUE)
```

# Random Permutations
While this all appears significant, it is possible that something is happening globally
to isoform usage in cells that have repressed transcription of essential genes. Since 
we are specifically interested in whether genes that are directly targeted show a pattern
of isoform usage change, we can use a null distribution of artificial composites that 
randomly take the usage levels from targeting perturbations, but not limiting to the 
targeted gene.

## Compute AWUI for permuted composites
```{r compute_perms}
idx_multi_target <- which(colSums(I_gene_target) > 0)

random_awui <- function () {
    I_gene_target_perm <- I_gene_target[,sample(idx_multi_target)]
    awui <- wui_gene_target[cbind(I_gene_target_perm@i+1, I_gene_target_perm@j+1)] %>%
        `names<-`(ens_gene[I_gene_target_perm@i+1]) %>% 
        enframe(name="gene", value="wui") %>%
        filter(!is.na(wui)) %>%
        group_by(gene) %>%
        summarize(wui=mean(wui)) %$%
        mean(wui)
    as.numeric(awui)
}

df_perms <- tibble(mode="permutation", awui=replicate(1000, random_awui())) %>%
    add_row(mode="self-targeting", awui=awui_self)
```

## Permuted composites distribution
Does the composite AWUI for self-targeted genes look like it comes from the distribution
of AWUIs from permuted composites?

```{r plt_awui_violin_perms, fig.width=2, fig.height=4}
df_perms %>%
    ggplot(aes(x="Permuted AWUI", y=awui)) +
    geom_violin(fill='lightgrey', size=0.2, draw_quantiles=c(0.25, 0.50, 0.75)) +
    geom_quasirandom(aes(color=mode), pch=16, size=2) +
    scale_color_manual(values=c("black", "blue"), guide='none') +
    theme_bw() +
    labs(x=NULL, y="Weighted Usage Index")
```

No, it again looks significantly higher

## t-Tests
### Test composite against permutations
```{r test_self_vs_perms}
t.test(filter(df_perms, mode != 'self-targeting')$awui, 
       filter(df_perms, mode == 'self-targeting')$awui,
       var.equal=TRUE)
```

Yes, significant.

### Test non-targeting versus permuted composites
```{r test_nt_vs_perms}
t.test(filter(df_awui, is_nt)$awui,
       filter(df_perms, mode != 'self-targeting')$awui)
```

Yes, but the effect size is an order of magnitude smaller.

# Individual Genes

## Example Plots
Let's plot some random examples. The blue dot represents the WUI value for gene
in the targeted case.
```{r sample_plts, fig.width=2, fig.height=4}
id2sym <- colData(se_tx_target) %>% as_tibble %>%
    select(target_gene_id, target_gene) %>% distinct %>%
    deframe()

for (i in sample.int(nrow(wui_gene_target), size=N_EXAMPLE_PLOTS)) {
    gene_label <- id2sym[rownames(wui_gene_target)[i]]
    idx_self <- which(I_gene_target[i,])
    print({
        tibble(target=colnames(wui_gene_target[,idx_nt]), wui=wui_gene_target[i,idx_nt]) %>%
            add_row(target="self-targeting", wui=wui_gene_target[i, idx_self]) %>%
            mutate(is_self_target=target == "self-targeting") %>%
            ggplot(aes(x=gene_label, y=wui)) +
            geom_violin() + 
            geom_quasirandom(aes(color=is_self_target)) +
            scale_y_continuous(limits=c(0,1)) +
            scale_color_manual(values=c("black", "blue"), guide='none') +
            theme_bw() +
            labs(x="Target Gene", y="WUI")
    })
}
```

# Conclusion

There is a significant effect of lengthing in the average weighted usage index (WUI) 
of CRISPRi-targeted genes versus controls. The individual WUIs, however, do show 
a broad range of perturbations.

---

# Runtime Details
## Session Info
```{r sesh_info, echo=FALSE}
sessionInfo()
```

## Conda Environment
```{bash comment="", echo=FALSE}
if ! command -v conda &> /dev/null
then
  echo "Conda not detected."
elif [ -z "${CONDA_PREFIX}" ]
then
  echo "No active Conda environment."
else
  echo "## Conda Environment YAML"
  conda env export
fi
```
